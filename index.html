<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hub Relocation Comparison Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html, body { height:100%; margin:0; }
#map { height:100%; }

.panel {
 position:absolute; top:10px; left:10px; z-index:1000;
 background:white; padding:14px;
 border-radius:10px;
 box-shadow:0 6px 20px rgba(0,0,0,0.15);
 width:320px;
 font-family:system-ui;
}

.section { margin-top:12px; }

button {
 width:100%; padding:10px;
 border:none; border-radius:8px;
 background:#111; color:white;
 cursor:pointer;
}

select { width:100%; padding:8px; border-radius:6px; }

.legend {
 position:absolute; bottom:10px; left:10px;
 background:white; padding:8px;
 border-radius:8px;
 font-size:13px;
 box-shadow:0 4px 12px rgba(0,0,0,0.12);
}
</style>
</head>

<body>

<div class="panel">
<b>Hub Route Comparison</b>

<div class="section">
<b>Select Origins</b><br>
<label><input type="checkbox" value="CURRENT" checked> CURRENT</label><br>
<label><input type="checkbox" value="P300"> P300</label><br>
<label><input type="checkbox" value="BIRULIA"> BIRULIA</label>
</div>

<div class="section">
<b>Select Hub</b>
<select id="hubSelect">
<option value="ALL">All Hubs</option>
</select>
</div>

<div class="section">
<button onclick="drawRoutes()">Draw Routes</button>
</div>

<div class="section" id="summary">
Ready.
</div>
</div>

<div class="legend">
ðŸ”µ CURRENT<br>
ðŸ”´ P300<br>
ðŸŸ¡ BIRULIA<br>
âš« HUB
</div>

<div id="map"></div>

<script>
<script>

const LOCATIONS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQSbj40C0zXAvuBK_YhgGstRJGBk7ACEqLpulxJzT_SE5_aeAetDbnPqMEB4MaQTy4EhF2IkcszUj3L/pub?gid=0&single=true&output=csv";
const HUBS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQSbj40C0zXAvuBK_YhgGstRJGBk7ACEqLpulxJzT_SE5_aeAetDbnPqMEB4MaQTy4EhF2IkcszUj3L/pub?gid=278580238&single=true&output=csv";

const map = L.map('map').setView([23.8,90.4],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let locations=[], hubs=[];
let routeLayer=L.layerGroup().addTo(map);
let markerLayer=L.layerGroup().addTo(map);
let selectedHubMarker=null;

const originColors={
 CURRENT:"#007bff",
 P300:"#dc3545",
 BIRULIA:"#ffc107"
};

function parseCSV(url){
 return new Promise(resolve=>{
  Papa.parse(url,{ download:true, header:true, complete:res=>resolve(res.data) });
 });
}

function loadData(){
 Promise.all([parseCSV(LOCATIONS_CSV_URL),parseCSV(HUBS_CSV_URL)])
 .then(data=>{
  locations=data[0].map(r=>({
   key:r["Location Key"],
   name:r["Location Name"],
   lat:parseFloat(r["Latitude"]),
   lon:parseFloat(r["Longitude"])
  }));

  hubs=data[1].map(r=>({
   name:r["Hub Name"],
   node:r["Node"],
   lat:parseFloat(r["Lat"]),
   lon:parseFloat(r["Lon"])
  }));

  populateHubDropdown();
  drawMarkers();
 });
}

function populateHubDropdown(){
 const sel=document.getElementById("hubSelect");
 hubs.forEach(h=>{
  const opt=document.createElement("option");
  opt.value=h.node;
  opt.textContent=h.node+" - "+h.name;
  sel.appendChild(opt);
 });
}

function drawMarkers(){
 markerLayer.clearLayers();

 locations.forEach(l=>{
  L.circleMarker([l.lat,l.lon],{
   radius:10,
   color:originColors[l.key]||"gray",
   fillOpacity:0.8
  }).addTo(markerLayer)
  .bindTooltip(l.key,{permanent:true,direction:"top"});
 });

 hubs.forEach(h=>{
  const marker=L.circleMarker([h.lat,h.lon],{
   radius:6,
   color:"#000",
   fillColor:"#000",
   fillOpacity:0.8
  }).addTo(markerLayer);

  marker.bindTooltip(h.node,{permanent:true,direction:"top"});
 });
}

async function drawRoutes(){

 routeLayer.clearLayers();
 document.getElementById("summary").innerHTML="Calculating...";

 let selectedOrigins=[...document.querySelectorAll("input[type=checkbox]:checked")].map(cb=>cb.value);
 let selectedHub=document.getElementById("hubSelect").value;

 let hubList=selectedHub==="ALL"?hubs:hubs.filter(h=>h.node===selectedHub);

 let summaryHTML="";

 for(let h of hubList){

  summaryHTML+="<b>"+h.node+"</b><br>";

  for(let originKey of selectedOrigins){

   let origin=locations.find(l=>l.key===originKey);
   if(!origin) continue;

   const url=`https://router.project-osrm.org/route/v1/driving/${origin.lon},${origin.lat};${h.lon},${h.lat}?overview=full&geometries=geojson`;
   const res=await fetch(url);
   const json=await res.json();
   if(!json.routes||!json.routes[0]) continue;

   let route=json.routes[0];
   let km=route.distance/1000;

   // Slight offset so overlapping routes separate visually
   L.geoJSON(route.geometry,{
    color:originColors[originKey],
    weight:5,
    opacity:0.8
   }).addTo(routeLayer);

   // Permanent distance label near hub
   L.marker([h.lat,h.lon],{
     icon:L.divIcon({
       className:"",
       html:`<div style="background:white;padding:2px 6px;border-radius:6px;font-size:11px;border:1px solid #ccc;">
       ${originKey}: ${km.toFixed(1)} km
       </div>`
     })
   }).addTo(routeLayer);

   summaryHTML+=`${originKey}: ${km.toFixed(2)} km<br>`;
  }

  summaryHTML+="<hr>";
 }

 document.getElementById("summary").innerHTML=summaryHTML;
}

loadData();

</script>

</script>

</body>
</html>
